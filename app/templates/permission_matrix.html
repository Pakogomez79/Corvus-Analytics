{% extends "layout.html" %}

{% block title %}Matriz de Permisos{% endblock %}

{% block content %}
<h2>Matriz de Permisos</h2>
<p>Marque los permisos que desea asignar a cada rol. Guardar aplicará los cambios a la base de datos.</p>

<form method="get" action="/permisos/matriz" style="display:flex; gap:0.75rem; align-items:center; margin-bottom:1rem;">
  <label style="display:flex; gap:0.5rem; align-items:center;"><span>Rol:</span>
    <select name="role_id">
      <option value="">Todos</option>
      {% for r in roles_all %}
        <option value="{{ r.id }}" {% if role_id and role_id|int == r.id %}selected{% endif %}>{{ r.name }}</option>
      {% endfor %}
    </select>
  </label>
  <label style="display:flex; gap:0.5rem; align-items:center;"><span>Buscar permiso:</span>
    <input type="search" name="q" placeholder="nombre o descripción" value="{{ q or '' }}" />
  </label>
  <div>
    <button class="btn btn-outline" type="submit">Filtrar</button>
    <a class="btn" href="/permisos/matriz/export?role_id={{ role_id or '' }}&q={{ q or '' }}">Exportar CSV</a>
    <a class="btn" href="/permisos/matriz">Restablecer</a>
  </div>
</form>

<form method="post" action="/permisos/matriz/guardar">
  <div class="table-responsive">
    <table class="matrix-table">
      <thead>
        <tr>
          <th>Permiso \ Rol</th>
          {% for r in roles %}
            <th>{{ r.name }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for p in permissions %}
          <tr>
            <td class="perm-name">{{ p.name }}<br><small>{{ p.description or '' }}</small></td>
            {% for r in roles %}
              <td class="perm-cell">
                {% set checked = (r.id, p.id) in assigned %}
                <input type="checkbox" name="assign_{{ r.id }}_{{ p.id }}" {% if checked %}checked{% endif %} />
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div style="margin-top: 1rem;">
    <button class="btn btn-primary" type="submit">Guardar matriz</button>
    <a class="btn" href="/permisos">Volver</a>
  </div>
</form>
{% endblock %}
