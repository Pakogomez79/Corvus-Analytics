{% extends "layout.html" %}

{% block title %}Auditoría - Corvus International Group{% endblock %}
{% block page_title %}Auditoría{% endblock %}
{% block breadcrumb %}Administración &gt; Auditoría{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div>
      <h3 class="card-title">Registro de Auditoría</h3>
      <p class="card-subtitle">Eventos importantes del sistema</p>
    </div>
    <div style="display:flex; gap:1rem; align-items:center;">
      <form id="auditoria-filters" method="get" action="/auditoria" style="display:flex; gap:0.75rem; align-items:center; flex-wrap:nowrap;">
        <input type="search" name="q" placeholder="Buscar mensaje o acción..." value="{{ q }}" style="padding:0.5rem 0.75rem; border:1px solid #e2e8f0; border-radius:6px;" />
        <select name="user" style="padding:0.45rem 0.6rem; border:1px solid #e2e8f0; border-radius:6px;">
          <option value="">Usuario (todos)</option>
          {% for a in actors %}
            <option value="{{ a }}" {% if a == user %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>
        <select name="module" style="padding:0.45rem 0.6rem; border:1px solid #e2e8f0; border-radius:6px;">
          <option value="">Módulo (todos)</option>
          {% for m in modules %}
            <option value="{{ m }}" {% if m == module %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
        <input type="date" name="date_from" value="{{ date_from }}" style="padding:0.35rem 0.5rem; border:1px solid #e2e8f0; border-radius:6px;" />
        <input type="date" name="date_to" value="{{ date_to }}" style="padding:0.35rem 0.5rem; border:1px solid #e2e8f0; border-radius:6px;" />
        <button class="btn btn-secondary" type="submit">Buscar</button>
        <button id="export-btn" class="btn btn-primary" type="button">Exportar CSV</button>
      </form>
    </div>
  </div>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Usuario</th>
          <th>Acción</th>
          <th>Mensaje</th>
          <th>Detalle</th>
        </tr>
      </thead>
      <tbody>
        {% if logs %}
          {% for l in logs %}
          <tr>
            <td>{{ l.created_at }}</td>
            <td>{{ l.actor_username or '-' }}</td>
            <td style="color:var(--text-secondary);">{{ l.action }}</td>
            <td>{{ l.mensaje_es or '-' }}</td>
            <td>
              {% if l.detalle_es %}
                <details><summary>Ver</summary><pre style="white-space:pre-wrap;">{{ l.detalle_es }}</pre></details>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" style="text-align:center; padding:2rem; color:var(--text-secondary);">No hay eventos</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; padding-top:0.75rem;">
    <div style="color:var(--text-secondary);">Mostrando {{ (page - 1) * per_page + 1 }} - {{ (page - 1) * per_page + logs|length }} de {{ total }}</div>
    <div>
      <nav aria-label="Paginación">
        <ul style="display:flex; gap:0.5rem; list-style:none; padding:0; margin:0;">
          {% if page > 1 %}
          <li><a class="btn btn-outline" href="/auditoria?page={{ page - 1 }}{% if q %}&q={{ q }}{% endif %}{% if user %}&user={{ user }}{% endif %}{% if module %}&module={{ module }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Anterior</a></li>
          {% else %}
          <li><button class="btn btn-outline" disabled>Anterior</button></li>
          {% endif %}

          {% for p in range(1, pages + 1) %}
            {% if p == page %}
              <li><button class="btn btn-primary" disabled>{{ p }}</button></li>
            {% else %}
              <li><a class="btn btn-secondary" href="/auditoria?page={{ p }}{% if q %}&q={{ q }}{% endif %}{% if user %}&user={{ user }}{% endif %}{% if module %}&module={{ module }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ p }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page < pages %}
          <li><a class="btn btn-outline" href="/auditoria?page={{ page + 1 }}{% if q %}&q={{ q }}{% endif %}{% if user %}&user={{ user }}{% endif %}{% if module %}&module={{ module }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Siguiente</a></li>
          {% else %}
          <li><button class="btn btn-outline" disabled>Siguiente</button></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  (function(){
    const exportBtn = document.getElementById('export-btn');
    if (!exportBtn) return;
    exportBtn.addEventListener('click', function(){
      const form = document.getElementById('auditoria-filters');
      if (!form) return;
      const params = new URLSearchParams(new FormData(form));
      const qs = params.toString();
      const url = '/auditoria/export' + (qs ? ('?' + qs) : '');
      window.location.href = url;
    });
  })();
</script>
{% endblock %}
